{% extends "base.html" %}
{% from "_form_helpers.html" import render_field %}

{% block title %}Gerenciar Grupo: {{ group.cn.value }}{% endblock %}

{% from "_macros.html" import render_page_header %}

{% block page_title %}
    {% set title_html %}
        <i class="fas fa-users-cog me-2"></i>Grupo: {{ group.cn.value }}
        <p class="text-muted mb-0 fs-6 fw-normal">{{ get_attr_value(group, 'description') or 'Sem descrição.' }}</p>
    {% endset %}
    {% set extra_actions_html %}
        <a href="{{ url_for('export_group_members', group_name=group.cn.value) }}" class="btn btn-secondary me-2">
            <i class="fas fa-file-csv me-2"></i>Exportar Membros
        </a>
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="fas fa-user-plus me-2"></i>Adicionar Usuário
        </button>
    {% endset %}
    {{ render_page_header(title_html, extra_actions=extra_actions_html, back_url=url_for('group_management')) }}
{% endblock %}

{% block content %}
<!-- Card da Lista de Membros -->
<div class="card glass-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Membros Atuais</h5>
        <div class="col-md-5 col-lg-4">
            <input type="text" id="member-search-input" class="form-control form-control-sm" placeholder="Filtrar membros atuais...">
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive" id="members-table-container">
            <div class="text-center p-5" id="loading-spinner">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Carregando membros...</p>
            </div>
        </div>
    </div>
    <div class="card-footer text-center">
        <span id="member-count-badge" class="badge bg-secondary rounded-pill fs-6">Carregando...</span>
    </div>
</div>

<!-- ========================================================================== -->
<!-- Modal de Adicionar Usuário                                                 -->
<!-- ========================================================================== -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel"><i class="fas fa-user-plus me-2"></i>Adicionar Usuário ao Grupo: {{ group.cn.value }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex mb-3">
                    <input type="text" id="user-search-input" class="form-control me-2" placeholder="Digite 3+ caracteres para buscar por nome ou login...">
                    <button id="user-search-button" class="btn btn-primary"><i class="fas fa-search"></i></button>
                </div>
                <div class="table-responsive" id="user-search-results-container" style="min-height: 200px;">
                    <p class="text-muted text-center pt-5">Aguardando busca...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Formulários ocultos para ações que precisam de POST. Eles são acionados via JavaScript. -->
<form id="remove-member-form" method="POST" style="display: none;"></form>

<!-- ========================================================================== -->
<!-- Modal de Adição Temporária de Usuário                                      -->
<!-- ========================================================================== -->
<div class="modal fade" id="addTempUserModal" tabindex="-1" aria-labelledby="addTempUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTempUserModalLabel"><i class="fas fa-clock me-2"></i>Adicionar Membro Temporariamente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Adicionando <strong id="temp-user-sam-display"></strong> ao grupo.</p>
                <div class="mb-3">
                    <label for="temp-start-date" class="form-label">Data de Início da Participação</label>
                    <input type="date" id="temp-start-date" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="temp-end-date" class="form-label">Data de Fim da Participação</label>
                    <input type="date" id="temp-end-date" class="form-control" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="confirm-temp-add-btn" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação Genérico -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">Confirmar Ação</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmationModalBody">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="confirmActionBtn" class="btn btn-primary">Confirmar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const groupName = {{ group.cn.value|tojson }};
    const csrfToken = "{{ form.csrf_token._value() }}";
    let memberListPage = 1;
    let memberListQuery = '';
    let memberDebounceTimer;
    let userSearchDebounceTimer;
    let selectedUserForTempAdd = null; // Guarda o SAM do usuário para o modal de adição temporária

    // === DOM Elements ===
    const membersTableContainer = document.getElementById('members-table-container');
    const memberLoadingSpinner = document.getElementById('loading-spinner');
    const memberSearchInput = document.getElementById('member-search-input');
    const memberCountBadge = document.getElementById('member-count-badge');

    const addUserModalEl = document.getElementById('addUserModal');
    const addUserModal = new bootstrap.Modal(addUserModalEl);
    const userSearchInput = document.getElementById('user-search-input');
    const userSearchButton = document.getElementById('user-search-button');
    const userSearchResultsContainer = document.getElementById('user-search-results-container');

    const addTempUserModalEl = document.getElementById('addTempUserModal');
    const addTempUserModal = new bootstrap.Modal(addTempUserModalEl);
    const tempUserSamDisplay = document.getElementById('temp-user-sam-display');
    const tempStartDateInput = document.getElementById('temp-start-date');
    const tempEndDateInput = document.getElementById('temp-end-date');
    let confirmTempAddBtn = document.getElementById('confirm-temp-add-btn');

    const confirmationModalEl = document.getElementById('confirmationModal');
    const confirmationModal = new bootstrap.Modal(confirmationModalEl);
    const confirmationModalLabel = document.getElementById('confirmationModalLabel');
    const confirmationModalBody = document.getElementById('confirmationModalBody');
    let confirmActionBtn = document.getElementById('confirmActionBtn');


    // Create the pagination container dynamically if it's missing, to avoid JS errors
    let paginationDiv = document.getElementById('pagination-container');
    if (!paginationDiv) {
        paginationDiv = document.createElement('div');
        paginationDiv.id = 'pagination-container';
        paginationDiv.className = 'd-flex justify-content-center mt-3';
        const card = document.querySelector('.card.glass-card');
        card.parentNode.insertBefore(paginationDiv, card.nextSibling);
    }

    // === Helper Functions ===
    function showLoading(container, message = 'Carregando...') {
        container.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">${message}</p></div>`;
    }

    function showError(container, message) {
        container.innerHTML = `<div class="alert alert-danger m-3">${message}</div>`;
    }

    function setupConfirmationModal(title, body, onConfirm) {
        confirmationModalLabel.textContent = title;
        confirmationModalBody.textContent = body;

        const newConfirmBtn = confirmActionBtn.cloneNode(true);
        confirmActionBtn.parentNode.replaceChild(newConfirmBtn, confirmActionBtn);
        confirmActionBtn = newConfirmBtn;

        confirmActionBtn.addEventListener('click', function() {
            onConfirm();
            confirmationModal.hide();
        }, { once: true });

        confirmationModal.show();
    }

    // === API Functions ===
    async function fetchMembers(page = 1, query = '') {
        showLoading(membersTableContainer);
        try {
            const response = await fetch(`/api/group_members/${groupName}?page=${page}&query=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error(`Erro na rede: ${response.statusText}`);
            const data = await response.json();
            renderMembers(data.members);
            renderPagination(data, paginationDiv, (newPage) => {
                memberListPage = newPage;
                fetchMembers(memberListPage, memberListQuery);
            });
            memberCountBadge.textContent = `${data.total} Membro(s)`;
        } catch (error) {
            console.error('Erro ao buscar membros:', error);
            showError(membersTableContainer, 'Falha ao carregar membros.');
            memberCountBadge.textContent = 'Erro';
        }
    }

    async function searchUsers(query) {
        showLoading(userSearchResultsContainer, 'Buscando...');
        try {
            const response = await fetch(`/api/search_users_for_group/${groupName}?query=${encodeURIComponent(query)}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Erro na busca');
            }
            const users = await response.json();
            renderUserSearchResults(users);
        } catch (error) {
            showError(userSearchResultsContainer, error.message);
        }
    }

    async function addMember(username) {
        try {
            const response = await fetch('/api/add_user_to_group', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                body: JSON.stringify({ username, group_name: groupName })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Erro desconhecido');
            showToast('Sucesso', 'Usuário adicionado ao grupo.', 'success');
            // Recarrega a lista de membros mantendo a página e o filtro atuais
            fetchMembers(memberListPage, memberListQuery);
            addUserModal.hide();
        } catch (error) {
            showToast(`Falha ao adicionar: ${error.message}`, 'error', 'Erro');
        }
    }

    async function addMemberTemp(username, startDate, endDate) {
        if (!startDate || !endDate) {
            showToast('Data de início e fim são obrigatórias.', 'error', 'Erro de Validação');
            return;
        }
        try {
            const response = await fetch('/api/add_user_to_group_temp', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                body: JSON.stringify({ username, group_name: groupName, start_date: startDate, end_date: endDate })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Erro desconhecido');
            showToast(result.message, 'success', 'Sucesso');
            addTempUserModal.hide();
            addUserModal.hide();
        } catch (error) {
            showToast(`Falha ao adicionar temporariamente: ${error.message}`, 'error', 'Erro');
        }
    }

    async function removeMember(username) {
        setupConfirmationModal('Confirmar Remoção', `Tem certeza que deseja remover '${username}' do grupo?`, async () => {
            try {
                const response = await fetch('/api/remove_user_from_group', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                    body: JSON.stringify({ username: username, group_name: groupName })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Erro desconhecido');
                showToast('Usuário removido do grupo.', 'success', 'Sucesso');
                fetchMembers(memberListPage, memberListQuery);
            } catch (error) {
                showToast(`Falha ao remover: ${error.message}`, 'error', 'Erro');
            }
        });
    }

    // === Render Functions ===
    function renderMembers(members) {
        if (!members || members.length === 0) {
            membersTableContainer.innerHTML = `<div class="alert alert-info m-3">Nenhum membro encontrado.</div>`;
            return;
        }
        const table = createTable(['Nome', 'Login', 'Cargo', 'Cidade', 'Ação']);
        const tbody = table.querySelector('tbody');
        members.forEach(member => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${member.displayName}</td>
                <td>${member.sAMAccountName}</td>
                <td>${member.title || 'N/A'}</td>
                <td>${member.city || 'N/A'}</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-danger remove-btn" data-user-sam="${member.sAMAccountName}" title="Remover">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
        });
        membersTableContainer.innerHTML = '';
        membersTableContainer.appendChild(table);
    }

    function renderUserSearchResults(users) {
        if (!users || users.length === 0) {
            userSearchResultsContainer.innerHTML = `<div class="alert alert-info m-0">Nenhum usuário encontrado.</div>`;
            return;
        }
        const table = createTable(['Nome', 'Login', 'Cargo', 'Cidade', 'Ações']);
        const tbody = table.querySelector('tbody');
        users.forEach(user => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${user.displayName}</td>
                <td>${user.sAMAccountName}</td>
                <td>${user.title || 'N/A'}</td>
                <td>${user.city || 'N/A'}</td>
                <td class="text-center">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-success add-permanent-btn" data-user-sam="${user.sAMAccountName}" title="Adicionar permanentemente"><i class="fas fa-plus"></i> Add</button>
                        <button class="btn btn-sm btn-info add-temp-btn" data-user-sam="${user.sAMAccountName}" title="Adicionar temporariamente"><i class="fas fa-clock"></i> Temp</button>
                    </div>
                </td>
            `;
        });
        userSearchResultsContainer.innerHTML = '';
        userSearchResultsContainer.appendChild(table);
    }

    function createTable(headers) {
        const table = document.createElement('table');
        table.className = 'table table-sm table-hover glass-table mb-0';
        const thead = table.createTHead();
        const tbody = table.createTBody();
        const headerRow = thead.insertRow();
        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            headerRow.appendChild(th);
        });
        return table;
    }

    function renderPagination(data, container, callback) {
        container.innerHTML = '';
        if (data.total_pages <= 1) return;
        const nav = document.createElement('nav');
        const ul = document.createElement('ul');
        ul.className = 'pagination pagination-sm justify-content-center';
        const prevDisabled = data.page === 1 ? 'disabled' : '';
        const nextDisabled = data.page === data.total_pages ? 'disabled' : '';
        ul.innerHTML += `<li class="page-item ${prevDisabled}"><a class="page-link" href="#" data-page="${data.page - 1}">Anterior</a></li>`;
        ul.innerHTML += `<li class="page-item disabled"><span class="page-link">Página ${data.page} de ${data.total_pages}</span></li>`;
        ul.innerHTML += `<li class="page-item ${nextDisabled}"><a class="page-link" href="#" data-page="${data.page + 1}">Próximo</a></li>`;
        nav.appendChild(ul);
        container.appendChild(nav);
        container.querySelectorAll('a.page-link').forEach(link => {
            if (!link.parentElement.classList.contains('disabled')) {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    callback(parseInt(link.dataset.page));
                });
            }
        });
    }

    // === Event Listeners ===
    memberSearchInput.addEventListener('keyup', function(event) {
        clearTimeout(memberDebounceTimer);
        memberDebounceTimer = setTimeout(() => {
            memberListPage = 1;
            memberListQuery = event.target.value;
            fetchMembers(memberListPage, memberListQuery);
        }, 300);
    });

    const triggerUserSearch = () => {
        const query = userSearchInput.value;
        if (query.length >= 3) {
            searchUsers(query);
        } else {
            userSearchResultsContainer.innerHTML = '<p class="text-muted text-center pt-5">Digite 3+ caracteres.</p>';
        }
    };

    userSearchButton.addEventListener('click', triggerUserSearch);
    userSearchInput.addEventListener('keyup', (e) => {
        clearTimeout(userSearchDebounceTimer);
        userSearchDebounceTimer = setTimeout(triggerUserSearch, 400);
    });

    membersTableContainer.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.remove-btn');
        if (removeBtn) {
            removeMember(removeBtn.dataset.userSam);
        }
    });

    userSearchResultsContainer.addEventListener('click', (e) => {
        const addBtn = e.target.closest('.add-permanent-btn');
        if (addBtn) {
            const userSam = addBtn.dataset.userSam;
            setupConfirmationModal('Confirmar Adição', `Adicionar '${userSam}' permanentemente ao grupo?`, () => {
                addMember(userSam);
            });
        }
        const tempBtn = e.target.closest('.add-temp-btn');
        if (tempBtn) {
            selectedUserForTempAdd = tempBtn.dataset.userSam;
            tempUserSamDisplay.textContent = selectedUserForTempAdd;
            const today = new Date().toISOString().split('T')[0];
            tempStartDateInput.value = today;
            tempEndDateInput.value = '';
            addTempUserModal.show();
        }
    });

    confirmTempAddBtn.addEventListener('click', () => {
        if (selectedUserForTempAdd) {
            addMemberTemp(selectedUserForTempAdd, tempStartDateInput.value, tempEndDateInput.value);
        }
    });

    addUserModalEl.addEventListener('hidden.bs.modal', () => {
        userSearchInput.value = '';
        userSearchResultsContainer.innerHTML = '<p class="text-muted text-center pt-5">Aguardando busca...</p>';
    });

    addTempUserModalEl.addEventListener('hidden.bs.modal', () => {
        selectedUserForTempAdd = null;
    });

    // Initial Load
    fetchMembers(memberListPage, memberListQuery);
});
</script>
{% endblock %}
