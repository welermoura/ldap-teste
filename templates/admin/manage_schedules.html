{% extends "base.html" %}

{% block title %}Gerenciar Agendamentos{% endblock %}

{% block page_title %}
<div class="page-header">
    <h1><i class="fas fa-calendar-alt me-2"></i>Gerenciar Agendamentos</h1>
    <div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary"><i class="fas fa-home me-2"></i>Home</a>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Voltar ao Painel</a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="card glass-card">
    <div class="card-header">
        <h5 class="mb-0">Agendamentos de Grupos Temporários</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover glass-table">
                <thead>
                    <tr>
                        <th>Usuário</th>
                        <th>Grupo</th>
                        <th>Início</th>
                        <th>Fim</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="schedules-table-body">
                    <!-- As linhas da tabela serão inseridas aqui via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirmar Cancelamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Você tem certeza de que deseja cancelar este agendamento e sua ação correspondente?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Sim, Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Edição -->
<div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editScheduleModalLabel">Editar Agendamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-schedule-id">
        <div class="mb-3">
          <label for="edit-start-date" class="form-label">Início do Acesso</label>
          <input type="date" class="form-control" id="edit-start-date">
        </div>
        <div class="mb-3">
          <label for="edit-end-date" class="form-label">Fim do Acesso</label>
          <input type="date" class="form-control" id="edit-end-date">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="save-changes-btn">Salvar Alterações</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.getElementById('schedules-table-body');
    const editModal = new bootstrap.Modal(document.getElementById('editScheduleModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    let schedulesData = [];
    let scheduleId = null; // Para delete e edit

    // Mapeia os nomes das ações para uma melhor exibição
    const actionDisplayNames = {
        'add': 'Início do Acesso',
        'remove': 'Fim do Acesso'
    };

    function renderTable() {
        tableBody.innerHTML = '';
        if (schedulesData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum agendamento encontrado.</td></tr>';
            return;
        }

        const groupedSchedules = schedulesData.reduce((acc, schedule) => {
            if (!acc[schedule.id]) {
                acc[schedule.id] = {};
            }
            acc[schedule.id][schedule.action] = schedule;
            if (!acc[schedule.id].details) {
                 acc[schedule.id].details = { user_sam: schedule.user_sam, group_name: schedule.group_name };
            }
            return acc;
        }, {});

        Object.entries(groupedSchedules).forEach(([id, group]) => {
             const tr = document.createElement('tr');
             const startDate = group.add ? new Date(group.add.execution_date + 'T00:00:00-03:00').toLocaleDateString('pt-BR') : 'N/A';
             const endDate = group.remove ? new Date(group.remove.execution_date + 'T00:00:00-03:00').toLocaleDateString('pt-BR') : 'N/A';

             tr.innerHTML = `
                <td>${group.details.user_sam}</td>
                <td>${group.details.group_name}</td>
                <td><span class="badge bg-success">${startDate}</span></td>
                <td><span class="badge bg-danger">${endDate}</span></td>
                <td>
                    <button class="btn btn-primary btn-sm edit-btn" data-id="${id}" title="Editar Agendamento">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm delete-btn" data-id="${id}" title="Cancelar Agendamento">
                        <i class="fas fa-trash-alt"></i> Cancelar
                    </button>
                </td>
             `;
             tableBody.appendChild(tr);
        });
    }

    function fetchSchedules() {
        fetch('/api/schedules')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'error');
                    return;
                }
                schedulesData = data.sort((a, b) => new Date(a.execution_date) - new Date(b.execution_date));
                renderTable();
            })
            .catch(error => {
                console.error('Erro ao buscar agendamentos:', error);
                showToast('Falha ao carregar agendamentos.', 'error');
            });
    }

    // Delegação de Eventos para Abrir Modais
    tableBody.addEventListener('click', function(event) {
        const target = event.target;
        const editBtn = target.closest('.edit-btn');
        const deleteBtn = target.closest('.delete-btn');

        if (editBtn) {
            scheduleId = editBtn.dataset.id;
            const scheduleGroup = schedulesData.filter(s => s.id === scheduleId);
            const addSchedule = scheduleGroup.find(s => s.action === 'add');
            const removeSchedule = scheduleGroup.find(s => s.action === 'remove');

            document.getElementById('edit-schedule-id').value = scheduleId;
            document.getElementById('edit-start-date').value = addSchedule ? addSchedule.execution_date : '';
            document.getElementById('edit-end-date').value = removeSchedule ? removeSchedule.execution_date : '';

            // Define o título do modal
            const modalTitle = document.getElementById('editScheduleModalLabel');
            if (addSchedule && removeSchedule) {
                modalTitle.textContent = `Editando Acesso de ${addSchedule.user_sam} a ${addSchedule.group_name}`;
            } else {
                modalTitle.textContent = 'Editar Agendamento';
            }

            editModal.show();
        }

        if (deleteBtn) {
            scheduleId = deleteBtn.dataset.id;
            deleteModal.show();
        }
    });

    // Salvar alterações do Modal de Edição
    document.getElementById('save-changes-btn').addEventListener('click', function() {
        const id = document.getElementById('edit-schedule-id').value;
        const startDate = document.getElementById('edit-start-date').value;
        const endDate = document.getElementById('edit-end-date').value;

        if (!id || !startDate || !endDate) {
            showToast('As datas de início e fim são obrigatórias.', 'error');
            return;
        }

        if (new Date(startDate) > new Date(endDate)) {
            showToast('A data de início não pode ser posterior à data de fim.', 'error');
            return;
        }

        fetch(`/api/schedules/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ start_date: startDate, end_date: endDate })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                fetchSchedules();
                editModal.hide();
            } else {
                showToast(data.error || 'Falha ao atualizar agendamento.', 'error');
            }
        })
        .catch(error => {
            console.error('Erro ao salvar alterações:', error);
            showToast('Ocorreu um erro ao salvar as alterações.', 'error');
        });
    });

    // Confirmar exclusão do Modal de Cancelamento
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (!scheduleId) return;

        fetch(`/api/schedules/${scheduleId}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                fetchSchedules();
            } else {
                showToast(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Erro ao cancelar agendamento:', error);
            showToast('Falha ao cancelar o agendamento.', 'error');
        })
        .finally(() => {
            deleteModal.hide();
            scheduleId = null;
        });
    });

    // Carrega os dados iniciais
    fetchSchedules();
});
</script>
{% endblock %}