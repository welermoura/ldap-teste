{% extends "base.html" %}
{% block title %}Gerenciar Agendamentos{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Gerenciar Agendamentos de Grupos Temporários</h2>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Usuário</th>
                    <th>Grupo</th>
                    <th>Ação</th>
                    <th>Data de Execução</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="schedules-table-body">
                <!-- As linhas da tabela serão inseridas aqui via JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirmar Cancelamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Você tem certeza de que deseja cancelar este agendamento e sua ação correspondente?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Sim, Cancelar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.getElementById('schedules-table-body');
    let schedulesData = [];
    let scheduleToDeleteId = null;

    // Mapeia os nomes das ações para uma melhor exibição
    const actionDisplayNames = {
        'add': 'Adicionar ao Grupo',
        'remove': 'Remover do Grupo'
    };

    function renderTable() {
        tableBody.innerHTML = '';
        if (schedulesData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum agendamento encontrado.</td></tr>';
            return;
        }

        // Agrupa os agendamentos por ID
        const groupedSchedules = schedulesData.reduce((acc, schedule) => {
            if (!acc[schedule.id]) {
                acc[schedule.id] = [];
            }
            acc[schedule.id].push(schedule);
            return acc;
        }, {});

        // Cria as linhas da tabela
        Object.values(groupedSchedules).forEach(group => {
            // Ordena para garantir que a remoção (data de fim) venha depois da adição (data de início) se as datas forem diferentes
            group.sort((a, b) => new Date(a.execution_date) - new Date(b.execution_date));

            group.forEach((schedule, index) => {
                const tr = document.createElement('tr');
                const executionDate = new Date(schedule.execution_date + 'T00:00:00-03:00'); // Considera a data como local
                const formattedDate = executionDate.toLocaleDateString('pt-BR');

                // Na primeira linha do grupo, mostra usuário e grupo com rowspan
                if (index === 0) {
                    tr.innerHTML += `<td rowspan="${group.length}">${schedule.user_sam}</td>`;
                    tr.innerHTML += `<td rowspan="${group.length}">${schedule.group_name}</td>`;
                }

                tr.innerHTML += `
                    <td>
                        <span class="badge ${schedule.action === 'add' ? 'bg-success' : 'bg-danger'}">
                            ${actionDisplayNames[schedule.action] || schedule.action}
                        </span>
                    </td>
                    <td>
                        <input type="date" class="form-control form-control-sm" value="${schedule.execution_date}" data-id="${schedule.id}" data-action="${schedule.action}" style="max-width: 150px;">
                    </td>
                `;

                // Botão de cancelar apenas na primeira linha do grupo
                if (index === 0) {
                    tr.innerHTML += `
                        <td rowspan="${group.length}" class="align-middle">
                            <button class="btn btn-danger btn-sm delete-btn" data-id="${schedule.id}" title="Cancelar Agendamento">
                                <i class="fas fa-trash-alt"></i> Cancelar
                            </button>
                        </td>`;
                }

                tableBody.appendChild(tr);
            });
        });
    }

    function fetchSchedules() {
        fetch('/api/schedules')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'error');
                    return;
                }
                // Ordena os dados por data de execução
                schedulesData = data.sort((a, b) => new Date(a.execution_date) - new Date(b.execution_date));
                renderTable();
            })
            .catch(error => {
                console.error('Erro ao buscar agendamentos:', error);
                showToast('Falha ao carregar agendamentos.', 'error');
            });
    }

    // Delegação de eventos para os botões de cancelar
    tableBody.addEventListener('click', function(event) {
        if (event.target.closest('.delete-btn')) {
            scheduleToDeleteId = event.target.closest('.delete-btn').dataset.id;
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteModal.show();
        }
    });

    // Ação de confirmação do modal de exclusão
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (!scheduleToDeleteId) return;

        fetch(`/api/schedules/${scheduleToDeleteId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                fetchSchedules(); // Atualiza a tabela
            } else {
                showToast(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Erro ao cancelar agendamento:', error);
            showToast('Falha ao cancelar o agendamento.', 'error');
        })
        .finally(() => {
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
            deleteModal.hide();
            scheduleToDeleteId = null;
        });
    });

    // Delegação de eventos para os inputs de data
    tableBody.addEventListener('change', function(event) {
        if (event.target.matches('input[type="date"]')) {
            const scheduleId = event.target.dataset.id;
            const newDate = event.target.value;
            const action = event.target.dataset.action;

            // Encontrar o agendamento correspondente para validação
            const scheduleGroup = schedulesData.filter(s => s.id === scheduleId);
            const addSchedule = scheduleGroup.find(s => s.action === 'add');
            const removeSchedule = scheduleGroup.find(s => s.action === 'remove');

            let startDate, endDate;

            if (action === 'add') {
                startDate = newDate;
                endDate = removeSchedule ? removeSchedule.execution_date : null;
            } else { // action === 'remove'
                startDate = addSchedule ? addSchedule.execution_date : null;
                endDate = newDate;
            }

            // Validar se a data de início é anterior à data de fim
            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                 showToast('Erro: A data de início não pode ser posterior à data de fim.', 'error');
                 event.target.value = schedulesData.find(s => s.id === scheduleId && s.action === action).execution_date; // Reverte a alteração
                 return;
            }


            fetch(`/api/schedules/${scheduleId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ execution_date: newDate, action: action })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    fetchSchedules(); // Atualiza a tabela para refletir a mudança
                } else {
                    showToast(data.error || 'Falha ao atualizar a data.', 'error');
                    // Reverte a alteração no input se a API falhar
                    event.target.value = schedulesData.find(s => s.id === scheduleId).execution_date;
                }
            })
            .catch(error => {
                console.error('Erro ao atualizar data:', error);
                showToast('Um erro ocorreu ao tentar atualizar a data.', 'error');
                event.target.value = schedulesData.find(s => s.id === scheduleId).execution_date;
            });
        }
    });

    // Carrega os dados iniciais
    fetchSchedules();
});
</script>
{% endblock %}