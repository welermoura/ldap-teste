{% extends "base.html" %}
{% from "_form_helpers.html" import render_field, render_submit_button %}
{% from "_macros.html" import render_log_table %}

{% block title %}Logs do Sistema - Admin{% endblock %}

{% block page_title %}
<div class="page-header">
    <h1><i class="fas fa-clipboard-list me-2"></i>Logs do Sistema</h1>
    <div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary"><i class="fas fa-home me-2"></i>Home</a>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Voltar ao Painel</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const logTabs = document.querySelectorAll('#logTabs .nav-link');
    const activeTabInput = document.getElementById('active_tab_input');
    const searchForm = document.getElementById('searchForm');

    // Seta o valor inicial no carregamento da página
    const activeTabOnLoad = document.querySelector('#logTabs .nav-link.active');
    if (activeTabOnLoad) {
        activeTabInput.value = activeTabOnLoad.getAttribute('data-bs-target').substring(1);
    }

    // Atualiza o valor quando uma nova aba é clicada
    logTabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            const newActiveTabId = event.target.getAttribute('data-bs-target').substring(1);
            activeTabInput.value = newActiveTabId;
        });
    });
});
</script>
{% endblock %}

{% block content %}
<div class="card glass-card mb-4">
    <div class="card-body">
        <form method="POST" action="{{ url_for('admin_logs') }}" class="d-flex" id="searchForm">
            {{ search_form.hidden_tag() }}
            <input type="hidden" name="active_tab" id="active_tab_input" value="{{ active_tab }}">
            <div class="flex-grow-1 me-2">
                {{ render_field(search_form.search_query, placeholder="Filtrar por usuário, ação, etc.", label_visible=false) }}
            </div>
            {{ render_submit_button(search_form.submit, class="btn btn-primary btn-lg") }}
        </form>
    </div>
</div>

<div class="card glass-card">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="logTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'creation' %}active{% endif %}" id="creation-tab" data-bs-toggle="tab" data-bs-target="#creation" type="button" role="tab" aria-controls="creation" aria-selected="{% if active_tab == 'creation' %}true{% else %}false{% endif %}">
                    <i class="fas fa-plus-circle me-1"></i>Criação ({{ logs.creation|length }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'alteration' %}active{% endif %}" id="alteration-tab" data-bs-toggle="tab" data-bs-target="#alteration" type="button" role="tab" aria-controls="alteration" aria-selected="{% if active_tab == 'alteration' %}true{% else %}false{% endif %}">
                    <i class="fas fa-edit me-1"></i>Alteração ({{ logs.alteration|length }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'exclusion' %}active{% endif %}" id="exclusion-tab" data-bs-toggle="tab" data-bs-target="#exclusion" type="button" role="tab" aria-controls="exclusion" aria-selected="{% if active_tab == 'exclusion' %}true{% else %}false{% endif %}">
                    <i class="fas fa-trash-alt me-1"></i>Exclusão ({{ logs.exclusion|length }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'movement' %}active{% endif %}" id="movement-tab" data-bs-toggle="tab" data-bs-target="#movement" type="button" role="tab" aria-controls="movement" aria-selected="{% if active_tab == 'movement' %}true{% else %}false{% endif %}">
                    <i class="fas fa-people-arrows me-1"></i>Movimentação ({{ logs.movement|length }})
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body p-0">
        <div class="tab-content" id="logTabsContent">
            <div class="tab-pane fade {% if active_tab == 'creation' %}show active{% endif %}" id="creation" role="tabpanel" aria-labelledby="creation-tab">
                {{ render_log_table(logs.creation) }}
            </div>
            <div class="tab-pane fade {% if active_tab == 'alteration' %}show active{% endif %}" id="alteration" role="tabpanel" aria-labelledby="alteration-tab">
                {{ render_log_table(logs.alteration) }}
            </div>
            <div class="tab-pane fade {% if active_tab == 'exclusion' %}show active{% endif %}" id="exclusion" role="tabpanel" aria-labelledby="exclusion-tab">
                {{ render_log_table(logs.exclusion) }}
            </div>
            <div class="tab-pane fade {% if active_tab == 'movement' %}show active{% endif %}" id="movement" role="tabpanel" aria-labelledby="movement-tab">
                {{ render_log_table(logs.movement) }}
            </div>
        </div>
    </div>
</div>
{% endblock %}
